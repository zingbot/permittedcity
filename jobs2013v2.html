<!DOCTYPE html>

<html>
    <head>
        <title>Sweeten NYC Renovation Job Map</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css' />

        <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.css" type="text/css" />
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.css" type="text/css" />
        <link rel="stylesheet" href="js/Leaflet.markercluster/MarkerCluster.css" />
        <link rel="stylesheet" href="js/Leaflet.markercluster/MarkerCluster.Default.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.ie.css" />
            <link rel="stylesheet" href="js/Leaflet.markercluster/MarkerCluster.Default.ie.css" />
        <![endif]-->
        <link rel="stylesheet" href="js/jQRangeSlider/css/classic-min.css" type="text/css" />
        <link rel="stylesheet" href="css/cartodbmod.css" type="text/css" />
        <link rel="stylesheet" href="css/custom.css">
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://libs.cartodb.com/cartodb.js/v3/cartodb.js" type="text/javascript"></script>
        <script src="js/Leaflet.markercluster/leaflet.markercluster.js" type="text/javascript"></script>

        <!-- Required scripts for date slider -->
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script src="js/jQRangeSlider/jQDateRangeSlider-min.js"></script>
        <script src="js/moment.min.js"></script>

        <!-- Javascript for map -->
        <script type="text/javascript">
            // Constants
            var SQL_API_PREFIX = 'http://zingbot.cartodb.com/api/v2/sql?q=',
                SQL_API_TABLE = 'swmasterfinalall_updated';
                SQL_API_TABLE_SW= 'portfolios_projects_sweetengeo';

            // Initial values
            var initialDateMin = new Date(2012, 8, 2),
                initialDateMax = new Date(2013, 8, 1);

            // Global state variables
            var dateMin = moment(initialDateMin).format('YYYY-MM-DD'),
                dateMax = moment(initialDateMax).format('YYYY-MM-DD'),
                sublayers = [],
                map,
                sweetenLayer;

            // Build the SQL for the layer that will be displayed
            function buildSQL() {
                var baseQuery = "SELECT * FROM " + SQL_API_TABLE;
                var conditions = buildSQLWhereConditions();
                return [baseQuery, conditions].join(' WHERE ');
            }

            // Build just the WHERE conditions for the SQL query
            function buildSQLWhereConditions() {
                var conditions =
                    "pre__filing_date >= '" + dateMin + "'::DATE AND " +
                    "pre__filing_date < '" + dateMax + "'::DATE";

                // Get the initial cost conditions
                var expensiveness_conditions = [];
                $(':checkbox:checked:not([data-sweeten])').each(function (i, checkbox) {
                    // Add a condition for each checked box
                    var lessthan = $(checkbox).data('less-than');
                    var greaterthan = $(checkbox).data('greater-than');

                    var c = [];
                    if (lessthan !== undefined) {
                        c.push('initial_cost <= ' + lessthan);
                    }
                    if (greaterthan !== undefined) {
                        c.push('initial_cost > ' + greaterthan);
                    }

                    expensiveness_conditions.push('(' + c.join(' AND ') + ')');
                });
                if (expensiveness_conditions.length !== 0) {
                    conditions += ' AND (' + expensiveness_conditions.join(' OR ') + ')';
                }
                else {
                    // No checkboxes selected--don't show any permit data
                    conditions += ' AND initial_cost < 0';
                }

                return conditions;
            }

            // Update the display layer's SQL
            function updatePermitLayerSQL() {
                if (sublayers[0] !== undefined) {
                    sublayers[0].setSQL(buildSQL());
                }
            }

            // Get all the rows very near to the given point, send back just
            // the rows to the given callback function
            function getDataNearPoint(latlng, callback) {
                var nearbyDataSql =
                    "SELECT * FROM " + SQL_API_TABLE + " " +
                    "WHERE ST_DWithin( " +
                      "the_geom, " +
                      "ST_GeomFromText( " +
                        "'POINT(" + latlng[1] + " " + latlng[0] + ")', " +
                        "4326 " +
                      "), " +
                      "0.00001" +
                    ")";

                // Add the standard WHERE conditions
                var sql = nearbyDataSql + ' AND ' + buildSQLWhereConditions();

                // Order by the filing date
                sql += ' ORDER BY pre__filing_date';
                $.getJSON(SQL_API_PREFIX + sql, function (data) {
                    callback(data.rows);
                });
            }

            function getDataForBIN(bin, callback) {
                // Only these columns are pulled from CartoDB
                var columns = [
                    '_display',
                    'job__',
                    'bin__',
                    'addressss',
                    "to_char(initial_cost, '999,999,999') AS initial_cost",
                    "to_char(cast(total_est_fee as double precision), '999,999,999') AS total_est_fee",
                    'owner_s_first_last_name',
                    'applicant_s_first_last_name',
                    'applicant_professional_title',
                    'job_description'
                ];
                var sql =
                    'SELECT ' + columns.join(',') + ' ' +
                    'FROM ' + SQL_API_TABLE + ' ' +
                    "WHERE bin__ = '" + bin + "'";
                sql += ' AND ' + buildSQLWhereConditions() + ' ORDER BY pre__filing_date';
                $.getJSON(SQL_API_PREFIX + sql, function (data) {
                    callback(data.rows);
                });
            }

            // Initialize the sublayer that holds job points
            function initializePermitSublayer(sublayer) {
                var subLayerOptions = {
                    sql: buildSQL()
                };
                sublayer.set(subLayerOptions);
                sublayer.setInteraction(true);
                sublayer.setInteractivity(['cartodb_id', 'latitude', 'longitude', 'bin__']);

                sublayer.on('featureClick', function (e, latlng, pos, data, layer) {
                    getDataForBIN(data['bin__'], function (data) {
                        var content = Mustache.render($('#infowindow_template').html(), {
                            rows: data,
                        });

                        //control popup width and height here
                        L.popup()
                            .setLatLng(latlng)
                            .setContent(content)
                            .openOn(map);
                    });
                });

                // Turning infowindow off makes the cursor no longer
                // become a pointer when the mouse is over a feature.
                // Fix that here.
                sublayer.on('featureOver', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', 'pointer');
                });

                sublayer.on('featureOut', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', '-moz-grab');
                    $('#map').css('cursor', '-webkit-grab');
                });
            }

            // Update the zoom{X} class on the map element. Nice for styling
            // differently based on the map's zoom level
            function updateZoomClass(map) {
                // Remove any previously set zoom classes
                for (var i = map.getMinZoom(); i <= map.getMaxZoom(); i++) {
                    $('#map').removeClass('zoom' + i);
                }

                // Add current zoom class
                $('#map').addClass('zoom' + map.getZoom());
            }

            $(document).ready(function () {

                map = L.map('map', {
                    zoomControl: true,
                    center: [40.7142, -74.0064],
                    zoom: 14,
                    maxZoom: 18,
                    minZoom: 13,
                    maxBounds:[[40.49,-74.26],[40.93,-73.655]]
                });
                updateZoomClass(map);

                //Mapbox tile layer
                L.tileLayer('http://a.tiles.mapbox.com/v3/zingbot.PermitBase/{z}/{x}/{y}.png', {
                    maxZoom: 17,
                    attribution: 'Mapbox'
                }).addTo(map);

                // layer id from the API
                var layerURL = 'http://zingbot.cartodb.com/api/v2/viz/1a843f50-1f0a-11e3-a567-5404a6a69006/viz.json';

                cartodb.createLayer(map, layerURL, { infowindow: false })
                   .addTo(map)
                   .on('done', function(layer) {
                        // Initialize sublayers
                        var permitSublayer = layer.getSubLayer(0);
                        initializePermitSublayer(permitSublayer);
                        sublayers.push(permitSublayer);
                    })
                    .on('error', function() {
                        console.log("some error occurred");
                    });

                // Initialize Sweeten projects layer
                var query = 'SELECT * FROM ' + SQL_API_TABLE_SW;
                var url = SQL_API_PREFIX + query + '&format=GeoJSON'
                $.getJSON(url, function (data) {

                    // Initialize MarkerCluster layer
                    sweetenLayer = new L.MarkerClusterGroup({
                        showCoverageOnHover: false,
                        singleMarkerMode: true,
                        spiderifyOnMaxZoom: false,
                        zoomToBoundsOnClick: false
                    });

                    // Spiderfy when a cluster is clicked
                    sweetenLayer.on('clusterclick', function (cluster) {
                        cluster.layer.spiderfy();
                    });

                    // Initialize layer using GeoJSON data
                    var geojsonLayer = L.geoJson(data, {

                        onEachFeature: function (feature, layer) {
                            var content = Mustache.render($('#sweeten_infowindow_template').html(), feature.properties);
                            layer.bindPopup(content, {
                                offset: [0, 0]              
                            });
                        }

                    });

                    // Add GeoJSON layer to MarkerCluster layer
                    sweetenLayer.addLayer(geojsonLayer);
                    map.addLayer(sweetenLayer);
                });

                // Always update the zoom class when zoom happens
                map.on('zoomend', function () {
                    updateZoomClass(map);
                });

                // Initialize the date slider
                $('#slider').dateRangeSlider({
                    arrows: false,
                    bounds: {
                        // 0-based months
                        min: new Date(2003, 0, 1),
                        max: new Date(2013, 10, 1)
                    },
                    defaultValues: {
                        min: initialDateMin,
                        max: initialDateMax
                    },
                    formatter: function (val) {
                        return moment(val).format('MMM YY');
                    },
                    step: {
                        months: 1
                    }
                });

                // Add event handlers to date slider
                $('#slider').bind('valuesChanged', function (e, data) {
                    // Update global state variables
                    dateMin = moment(data.values.min).format('YYYY-MM-DD');

                    // Add a month so we can ask for records less than dateMax
                    // and still get records in the max month
                    dateMax = moment(data.values.max).add('months', 1).format('YYYY-MM-DD');

                    // Update the SQL of the layer
                    updatePermitLayerSQL();
                });
            });

            $(document).on('change', ':checkbox:not([data-sweeten])', function() {
              updatePermitLayerSQL();
            });

            // Add or remove sweeten layer on checkbox change
            $(document).on('change', ':checkbox[data-sweeten]', function() {
                if ($(this).is(':checked')) {
                    map.addLayer(sweetenLayer);
                }
                else {
                    map.removeLayer(sweetenLayer);
                }
            });

        </script>
    </head>

  <body>
    <div class="panel">
      <header>
        <h1>New York City</h1>
      </header>
      <article>
          <h3>Department of Buildings</h3>
          <label>
            <figure><img src="img/350kbulletv2.png"></figure>
            <span>Up to $350K</span>
            <input type="checkbox" data-less-than="350000" checked="checked">
          </label>
          <label>
            <figure><img src="img/350to1bulletv2.png"></figure>
            <span>$350K to $1M</span>
            <input type="checkbox" data-greater-than="350000" data-less-than="1000000" checked="checked">
          </label>
          <label>
            <figure><img src="img/1to5bulletv2.png"></figure>
            <span>$1M to $5M</span>
            <input type="checkbox" data-greater-than="1000000" data-less-than="5000000" checked="checked">
          </label>
          <label>
            <figure><img src="img/5milplusv2.png"></figure>
            <span>Over $5M</span>
            <input type="checkbox" data-greater-than="5000000" checked="checked">
          </label>

          <h3>Sweeten</h3>
          <label>
            <figure><img src="http://cascadia.linepointpath.com/dev/permittedcity/img/Sweeten30px.svg"></figure>
            <span>projects</span>
            <input type="checkbox" data-sweeten checked="checked">
          </label>
          <p>Sweeten produces a regular newsletter that tracks renovation trends in New York City&mdash;based on research that uses case studies, proprietary data, and publicly available information&mdash;to understand the overall market.</p>
<!--           <form action="http://swee10.us1.list-manage.com/subscribe/post?u=468d331ad04964faf7472cc8b&amp;amp;id=8288740962" class="validate" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form">
            <fieldset>
              <label>Subscribe to our newsletter</label>
              <input id="mce-EMAIL" name="EMAIL" placeholder="example@address.com" required="" type="email">
              <input class="button" id="mc-embedded-subscribe" name="subscribe" type="submit" value="Subscribe">
            </fieldset>
          </form> -->
          <ul class="social">
            <li><a href="http://sweeten.com" class="sweeten">Sweeten</a></li>
            <li><a href="http://twitter.com/The_Sweeten" class="twitter" rel="nofollow" target="_blank">Sweeten on Twitter</a></li>
            <li><a href="http://facebook.com/theSweeten" class="facebook" rel="nofollow" target="_blank">Sweeten on Facebook</a></li>
          </ul>
      </article>
    </div>

    <div id="map"></div>
    <div id="slider"></div>

    <script type="infowindow/html" id="infowindow_template">
      {{#rows}}
        <header><h2>{{addressss}}</h2></header>
        <section>
          <h3>Owner: {{owner_s_first_last_name}}</h3>
          <h3>Applied: {{_display}}</h3>
          <h3>Applicant: {{applicant_s_first_last_name}}, {{applicant_professional_title}}</h3>
          <p>{{job_description}}</p>
          <p>
            Estimated cost: ${{initial_cost}}
            <br>
            Estimated fee: ${{total_est_fee}}
          </p>
          <p><a href="http://a810-bisweb.nyc.gov/bisweb/JobsQueryByNumberServlet?requestid=1&passjobnumber={{job__}}" target="_blank">View #{{job__}} on DOB</a></p>
        </section>
      {{/rows}}
    </script>

    <script type="infowindow/html" id="sweeten_infowindow_template">
      <header><h2>Sweeten</h2></header>
      <section>
        <h3>{{title}}</h3>
        <p>{{_desc}}</p>
        <p><img src="{{img}}"></p>
        <p><a href="http://sweeten.com/{{sweeten_type}}s/{{sweeten_id}}" target="_parent">View project on Sweeten</a></p>
      </section>
    </script>
  </body>
</html>
