<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">

<html>
    <head>
        <title>Permitted City</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css' />
        <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
        <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.css" type="text/css" />
        <link rel="stylesheet" href="css/cartodbmod.css" type="text/css" />
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.css" type="text/css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.ie.css" />
        <![endif]-->
        <link rel="stylesheet" href="js/jQRangeSlider/css/classic-min.css" type="text/css" />

        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://libs.cartodb.com/cartodb.js/v3/cartodb.js" type="text/javascript"></script> 

        <!-- Required scripts for date slider -->
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script src="js/jQRangeSlider/jQDateRangeSlider-min.js"></script>
        <script src="js/moment.min.js"></script>

        <!-- Javascript for map -->
        <script type="text/javascript">

            // These were the actions for the Year Select buttons, their 
            // queries will be useful for the slider
            var LayerActions = {
                all: function(){
                    sublayers[1].setSQL("SELECT * FROM swmasterfinal");
                    return true;
                },
                twelve: function(){
                    //this SQL tested in CartoDB
                    sublayers[1].setSQL("SELECT * FROM swmasterfinal WHERE EXTRACT(YEAR FROM pre__filing_date) = '2012'");
                    return true;
                },
                thirteen: function(){
                    //this SQL tested in CartoDB
                    sublayers[1].setSQL("SELECT * FROM swmasterfinal WHERE EXTRACT(YEAR FROM pre__filing_date) = '2013'");
                    return true;
                }
            };

            $(document).ready(function () {

                var map = L.map('map', { 
                    zoomControl: true,
                    center: [40.7142, -74.0064],
                    zoom: 13,
                    maxZoom: 18,
                    minZoom: 13,
                    maxBounds:[[40.49,-74.26],[40.93,-73.655]]
                });

                /* L.tileLayer('http://{s}.tile.cloudmade.com/8f4df2ed0acc44269b35bd8e5a692069/109451/256/{z}/{x}/{y}.png', { maxZoom: 20, attribution: 'Mapbox' }).addTo(map); 
                */

                //Mapbox tile layer
                L.tileLayer('http://a.tiles.mapbox.com/v3/zingbot.PermitBase/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Mapbox' }).addTo(map);

                // layer id from the API
                var layerURL = 'http://zingbot.cartodb.com/api/v2/viz/1a843f50-1f0a-11e3-a567-5404a6a69006/viz.json';

                cartodb.createLayer(map,layerURL)
                   .addTo(map)
                   .on('done', function(layer) {
                        // get sublayer 0 and set the infowindow template

                        //This is for the time buttons THIS IS CAUSING AN ERROR
                        var sublayers = [];

                        //gets viz layers. 0 is layer 1, 1 is layer 2
                        var sublayer = layer.getSubLayer(1); 
                        var subLayerOptions = {sql: "SELECT * FROM swmasterfinal"}

                        //This is for the time buttons
                        sublayer.set(subLayerOptions);
                        sublayers.push(sublayer);

                        //This is where the infowindow is activated
                        sublayer.infowindow.set('template', $('#infowindow_template').html());
                    })
                    .on('error', function() {
                        console.log("some error occurred");
                    });

                // Initialize the date slider
                $('#slider').dateRangeSlider({
                    arrows: false,
                    bounds: {
                        // 0-based months
                        min: new Date(2007, 0, 1),
                        max: new Date(2013, 11, 1)
                    },
                    formatter: function (val) {
                        return moment(val).format('MMMM YYYY');
                    },
                    step: {
                        months: 1
                    }                        
                });
            });
        </script>

    </head>
    <body>

        <div id="legend">
            <!-- 	Information panel on left side -->
            <div id="sweetenpanel">
                <h4>Sweeten produces a regular...</h4>
            </div>
        </div>

        <div id="slider"></div>

        <!-- Begin Map-->
        <div id="map"></div>

        <script type="infowindow/html" id="infowindow_template">
            <!-- popup window -->
            <div class="cartodb-popup">
                <a href="#close" class="cartodb-popup-close-button close">x</a>
                <div class="cartodb-popup-content-wrapper">
                    <div class="cartodb-popup-content">
                        <!--    Unformatted version of pre_filing_date -->
                        <h4>{{content.data._display}}</h4>
                            
                        <!--  Loads the job page from the NYC DOB site -->
                        <a href = "http://a810-bisweb.nyc.gov/bisweb/JobsQueryByNumberServlet?requestid=1&passjobnumber={{content.data.job__}}" target="blank"> Job No. {{content.data.job__}}</a><br />
                              
                        <!--      Loads the building information page form the NYC DOB site -->
                        <a href = "http://a810-bisweb.nyc.gov/bisweb/PropertyProfileOverviewServlet?bin={{content.data.bin__}}" target="blank" >Building No.{{content.data.bin__}}  </a>
                                
                        <!--      Address, cost of project and fee -->
                        <h2>{{content.data.addressss}}</h2>
                        <hr /> 
                        <h4>Reported work cost</h4>
                        <h1> ${{content.data.initial_cost}}</h1>
                        <h4>Total Estimated Fee</h4>
                        <h6> ${{content.data.total_est_fee}}</h6>
                        <hr />
                                
                        <!--      Owner and applicant -->
                        <h4>Owner:</h4><h3>{{content.data.owner_s_first_last_name}}</h3>
                        <hr />
                        <h4>Applicant</h4>
                        <h3>{{content.data.applicant_s_first_last_name}}</h3>
                        <h4>Title:</h4>
                        <h3>{{content.data.applicant_professional_title}}</h3>
                        <h5>{{content.data.job_description}}</h5>
                    </div>
                </div>
                <div class="cartodb-popup-tip-container"></div>
            </div>
        </script> 

    </body>
</html>
