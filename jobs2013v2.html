<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">

<html>
    <head>
        <title>Sweeten NYC Renovation Job Map</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <script type="text/javascript" src="//use.typekit.net/ayw2ujc.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css' />
        
        <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
        <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.css" type="text/css" />
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.css" type="text/css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.ie.css" />
        <![endif]-->
        <link rel="stylesheet" href="js/jQRangeSlider/css/classic-min.css" type="text/css" />
        <link rel="stylesheet" href="css/cartodbmod.css" type="text/css" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://libs.cartodb.com/cartodb.js/v3/cartodb.js" type="text/javascript"></script> 

        <!-- Required scripts for date slider -->
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script src="js/jQRangeSlider/jQDateRangeSlider-min.js"></script>
        <script src="js/moment.min.js"></script>

        <!-- Javascript for map -->
        <script type="text/javascript">

            // Constants
            var SQL_API_PREFIX = 'http://zingbot.cartodb.com/api/v2/sql?q=',
                SQL_API_TABLE = 'swmasterfinal';
				SQL_API_TABLE_SW= 'swprojects';

            // Initial values
            var initialDateMin = new Date(2012, 1, 2),
                initialDateMax = new Date(2013, 1, 1);

            // Global state variables
            var dateMin = moment(initialDateMin).format('YYYY-MM-DD'),
                dateMax = moment(initialDateMax).format('YYYY-MM-DD'),
                sublayers = [],
                map;

            // Build the SQL for the layer that will be displayed
            function buildSQL() {
                var baseQuery = "SELECT * FROM " + SQL_API_TABLE;
                var conditions = buildSQLWhereConditions(); 
                return [baseQuery, conditions].join(' WHERE ');
            }

            // Build just the WHERE conditions for the SQL query
            function buildSQLWhereConditions() {
                var conditions =  
                    "pre__filing_date >= '" + dateMin + "'::DATE AND " +
                    "pre__filing_date < '" + dateMax + "'::DATE";

                // Get the initial cost conditions
                var expensiveness_conditions = [];
                $('#filters #expensiveness :input:checked:not(#sweeten)').each(function (i, checkbox) {
                    // Add a condition for each checked box
                    var lessthan = $(checkbox).data('less-than');
                    var greaterthan = $(checkbox).data('greater-than');

                    var c = [];
                    if (lessthan !== undefined) {
                        c.push('initial_cost <= ' + lessthan);
                    }
                    if (greaterthan !== undefined) {
                        c.push('initial_cost > ' + greaterthan);
                    }

                    expensiveness_conditions.push('(' + c.join(' AND ') + ')');
                });
                if (expensiveness_conditions.length !== 0) {
                    conditions += ' AND (' + expensiveness_conditions.join(' OR ') + ')';
                }

                return conditions;
            }

            // Update the display layer's SQL
            function updatePermitLayerSQL() {
                if (sublayers[0] !== undefined) {
                    sublayers[0].setSQL(buildSQL());
                }
            }

            function updateSweetenLayerSQL(checked) {
                if (sublayers[1] !== undefined) {
                    //sublayers[1].setSQL(buildSQL());
                    if (checked) {
                        sublayers[1].setSQL('SELECT * FROM swprojects');
                    }
                    else {
                        sublayers[1].setSQL('SELECT * FROM swprojects WHERE 0=1');
                    }
                }
            }

            // Get all the rows very near to the given point, send back just 
            // the rows to the given callback function
            function getDataNearPoint(latlng, callback) {
                var nearbyDataSql = 
                    "SELECT * FROM " + SQL_API_TABLE + " " +
                    "WHERE ST_DWithin( " +
                      "the_geom, " +
                      "ST_GeomFromText( " +
                        "'POINT(" + latlng[1] + " " + latlng[0] + ")', " +
                        "4326 " +
                      "), " +
                      "0.0004" +
                    ")";

                // Add the standard WHERE conditions
                var sql = nearbyDataSql + ' AND ' + buildSQLWhereConditions();

                // Order by the filing date
                sql += ' ORDER BY pre__filing_date';
                $.getJSON(SQL_API_PREFIX + sql, function (data) {
                    callback(data.rows);
                });
            }

            function getDataForBIN(bin, callback) {
                // Only these columns are pulled from CartoDB
                var columns = [
                    '_display',
                    'job__',
                    'bin__',
                    'addressss',
                    "to_char(initial_cost, '999,999,999') AS initial_cost",
                    "to_char(cast(total_est_fee as double precision), '999,999,999') AS total_est_fee",
                    'owner_s_first_last_name',
                    'applicant_s_first_last_name',
                    'applicant_professional_title',
                    'job_description'
                ];
                var sql = 
                    'SELECT ' + columns.join(',') + ' ' +
                    'FROM ' + SQL_API_TABLE + ' ' +
                    "WHERE bin__ = '" + bin + "'";
                sql += ' AND ' + buildSQLWhereConditions() + ' ORDER BY pre__filing_date';
                $.getJSON(SQL_API_PREFIX + sql, function (data) {
                    callback(data.rows);
                });
            }

            // Initialize the sublayer that holds permit points
            function initializePermitSublayer(sublayer) {
                var subLayerOptions = {
                    sql: buildSQL() 
                };
                sublayer.set(subLayerOptions);
                sublayer.setInteraction(true);
                sublayer.setInteractivity(['cartodb_id', 'latitude', 'longitude', 'bin__']);

                sublayer.on('featureClick', function (e, latlng, pos, data, layer) {
                    getDataForBIN(data['bin__'], function (data) {
                        var content = Mustache.render($('#infowindow_template').html(), {
                            rows: data,
                        });
                        
                        //control popup width and height here
                        L.popup({ maxHeight: 200, maxWidth:160 })
                            .setLatLng(latlng)
                            .setContent(content)
                            .openOn(map);
                    });
                });

                // Turning infowindow off makes the cursor no longer 
                // become a pointer when the mouse is over a feature.
                // Fix that here.
                sublayer.on('featureOver', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', 'pointer');
                });

                sublayer.on('featureOut', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', '-moz-grab');
                    $('#map').css('cursor', '-webkit-grab');
                });
            }

            function initializeSweetenSublayer(sublayer) {
                sublayer.set({ sql: 'SELECT * FROM swprojects' });
                sublayer.setInteraction(true);
                // Add other columns you want in the popup here
                sublayer.setInteractivity(['cartodb_id', 'lat', 'lng', 'description', 'homeowner', 'title', 'url', 'id']);

                sublayer.on('featureClick', function (e, latlng, pos, data, layer) {
                    var content = Mustache.render($('#sweeten_infowindow_template').html(), data);

                    //control popup width and height here
                    L.popup({ maxHeight: 200, maxWidth:160 })
                        .setLatLng(latlng)
                        .setContent(content)
                        .openOn(map);
                });

                // Turning infowindow off makes the cursor no longer 
                // become a pointer when the mouse is over a feature.
                // Fix that here.
                sublayer.on('featureOver', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', 'pointer');
                });

                sublayer.on('featureOut', function (e, latlng, pos, data, layer) {
                    $('#map').css('cursor', '-moz-grab');
                    $('#map').css('cursor', '-webkit-grab');
                });
           }

            $(document).ready(function () {

  $( "#legendTop" ).click(function() {
  if ( $( "#filters" ).is( ":hidden" ) ) {
    $( "#filters" ).show( "slow" );
  } else {
    $( "#filters" ).slideUp();
  }
});
  $( "#sweetenpanelsm_title" ).click(function() {
  if ( $( "#sweetenpanelsm_content" ).is( ":hidden" ) ) {
    $( "#sweetenpanelsm_content" ).show( "slow" );
  } else {
    $( "#sweetenpanelsm_content" ).slideUp();
  }
});

                map = L.map('map', { 
                    zoomControl: true,
                    center: [40.7142, -74.0064],
                    zoom: 14,
                    maxZoom: 18,
                    minZoom: 13,
                    maxBounds:[[40.49,-74.26],[40.93,-73.655]]
                });

                //Mapbox tile layer
                L.tileLayer('http://a.tiles.mapbox.com/v3/zingbot.PermitBase/{z}/{x}/{y}.png', { 
                    maxZoom: 17,
                    attribution: 'Mapbox'
                }).addTo(map);

                // layer id from the API
                var layerURL = 'http://zingbot.cartodb.com/api/v2/viz/1a843f50-1f0a-11e3-a567-5404a6a69006/viz.json';

                cartodb.createLayer(map, layerURL, { infowindow: false })
                   .addTo(map)
                   .on('done', function(layer) {
                        // Initialize sublayers
                        var permitSublayer = layer.getSubLayer(1); 
                        initializePermitSublayer(permitSublayer);
                        sublayers.push(permitSublayer);

                        var sweetenSublayer = layer.getSubLayer(0); 
                        initializeSweetenSublayer(sweetenSublayer);
                        sublayers.push(sweetenSublayer);
                    })
                    .on('error', function() {
                        console.log("some error occurred");
                    });

                // Initialize the date slider
                $('#slider').dateRangeSlider({
                    arrows: true,
                    bounds: {
                        // 0-based months
                        min: new Date(2012, 0, 1),
                        max: new Date(2013, 8, 1)
                    },
                    defaultValues: {
                        min: initialDateMin,
                        max: initialDateMax
                    },
                    formatter: function (val) {
                        return moment(val).format('MMM YY');
                    },
                    step: {
                        months: 1
                    }                        
                });

                // Add event handlers to date slider
                $('#slider').bind('valuesChanged', function (e, data) {
                    // Update global state variables
                    dateMin = moment(data.values.min).format('YYYY-MM-DD');

                    // Add a month so we can ask for records less than dateMax 
                    // and still get records in the max month
                    dateMax = moment(data.values.max).add('months', 1).format('YYYY-MM-DD');

                    // Update the SQL of the layer
                    updatePermitLayerSQL();
                });

                // Update layer when expensiveness checkbox changes
                $('#filters #expensiveness :input:not(#sweeten)').change(function () {
                    updatePermitLayerSQL();
                });

                // Update layer when expensiveness checkbox changes
                $('#filters #expensiveness :input#sweeten').change(function () {
                    updateSweetenLayerSQL($(this).is(':checked'));
                });

            });
            
                   </script>

    </head>
    <body>

        <div id="legend">
            <!-- Information panel on left side -->
            <div id="legendTop"><h2>NEW YORK CITY</h2><img src='http://sweeten.com/assets/select-box-arrow.png'></div>
            
            
            <div id="filters">
                <ul id="expensiveness">
                    <li>
                        <label for="expensiveness0">
                            <span id="expensiveness0-bullet" class="bullet-wrapper">
                                <img src="img/350kbullet.png" alt="350k" height="14" width="14" />
                            </span>
                            <span class="expensiveness-text">
                                up to $350K
                            </span>
                        </label> 
                        <input checked="checked" id="expensiveness0" data-less-than="350000" type="checkbox" />
                    </li>
                    <li>
                        <label for="expensiveness1">
                            <span id="expensiveness1-bullet" class="bullet-wrapper">
                                <img src="img/350to1bullet.png" alt="350kto1m" height="17" width="17" />
                            </span>
                            <span class="expensiveness-text">
                                $350K to $1M
                            </span>
                        </label>
                        <input checked="checked" id="expensiveness1" data-less-than="1000000" data-greater-than="350000" type="checkbox" />
                    </li>
                    <li>
                        <label for="expensiveness2">
                            <span id="expensiveness2-bullet" class="bullet-wrapper">
                                <img src="img/1to5bullet.png" alt="1mto5m" height="22" width="23" />
                            </span>
                            <span class="expensiveness-text">
                                $1m to $5m
                            </span>
                        </label>
                        <input checked="checked" id="expensiveness2" data-less-than="5000000" data-greater-than="1000000" type="checkbox" />
                    </li>
                    <li>
                        <label for="expensiveness3">
                            <span class="bullet-wrapper">
                                <img src="img/5milplus.png" alt="5milplus" height="25" width="26" />
                            </span>
                            <span class="expensiveness-text">
                                over $5M
                            </span>
                        </label>
                        <input checked="checked" id="expensiveness3" data-greater-than="5000000" type="checkbox" />
                     </li>
                     <li>
                        <label for="sweeten">
                            <span id="sweeten-bullet" class="bullet-wrapper">
                                <img src="img/sweeten.png" alt="Sweeten Projects" height="14" width="14" />  
                            </span>
                            <span class="expensiveness-text">
                                Sweeten
                            </span>
                        </label>
                        <input checked="checked" id="sweeten" type="checkbox" />
                     </li>
                </ul>

            
            
            </div>
        </div>

 <div id="sweetenpanelsm">
 <div id="sweetenpanelsm_title">SWEETEN<img src='http://sweeten.com/assets/select-box-arrow.png'></div>
                
               <div id="sweetenpanelsm_content"> <h5>Sweeten produces a regular newsletter that tracks renovation trends in New York City – based on research that uses case studies, proprietary data, and publicly available information  – to understand the overall market. </h5>
                    
                <div id="sw_form"><form action="http://swee10.us1.list-manage.com/subscribe/post?u=468d331ad04964faf7472cc8b&amp;amp;id=8288740962" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form" target="_blank">
                    <fieldset>
                        <input class="required email" id="mce-EMAIL" name="EMAIL" title="your.email@example.com" type="text" value="" /><br>
                     <input id="mc-embedded-subscribe" name="subscribe" type="submit" value="Subscribe" />
                    </fieldset>
                </form></div>
               </div>
            </div>


        <div id="map"></div>
                    <div id="slider">
                    <h4>DRAG TO CHANGE TIME</h4> 
	              
	                    
                    </div>

        <script type="infowindow/html" id="infowindow_template">
            <div class="popup-content">
               <!-- This iteratates over each row that was returned from the SQL query -->
               <!-- Only has access to columns specified in getDataForBIN -->               <div id='bintotal'><h4>Listing XX jobs</h4></div> 

               {{#rows}}
                                
               <div id='binlink'>  <a  href="http://a810-bisweb.nyc.gov/bisweb/PropertyProfileOverviewServlet?bin={{bin__}}" target="blank" >Building No. {{bin__}}  </a></div>
                    <div class="popup-content-section">
                        
                        <!-- Load the job page from the NYC DOB site -->
                        <div id=  "job_number"><a href="http://a810-bisweb.nyc.gov/bisweb/JobsQueryByNumberServlet?requestid=1&passjobnumber={{job__}}" target="blank"> Job No. {{job__}}</a></div><div id="date_display"> <h4>{{_display}}</h4></div>

                        <!-- Load the building information page form the NYC DOB site -->
                        <!-- Unformatted version of pre_filing_date -->
                        <!-- Address, cost of project and fee -->
                       <div id="address"> <h2>{{addressss}}</h2></div>
                         <h4>Reported work cost</h4>
                         <div id="initial_cost"> <h1>${{initial_cost}}</h1></div>
                       <h4>Total Estimated Fee</h4>
                        <div id="estimated_fee"> <h2>${{total_est_fee}}</h2></div>
                        <hr /> 

                        <!-- Owner and applicant -->
                        <h4>Owner</h4></br>
                       <div id="owner_name"> <h3>{{owner_s_first_last_name}}</h3></div></br>
                        <h4>Applicant</h4></br>
                        <h3>{{applicant_s_first_last_name}}</h3></br>
                        <div id="profes_title"><h3>({{applicant_professional_title}})</h3></div></br>
                        <h4>Job detail</h4><h5>{{job_description}}</h5>
                        
                    </div>
                    </br>
                    </br>
                   
                {{/rows}}
            </div>
        </script> 

        <script type="infowindow/html" id="sweeten_infowindow_template">
            <!-- You will only have access to the columns set in initializeSweetenSublayer -->
            <div id="sw_popup_brand"><h2>SWEETEN</h2></div><hr/>
            <div class="popup-content">
                <div id="sw_pop_title">{{title}}</div>
                <div id="sw_pop_desc">{{description}}</div>
                <div id=  "sw_popup_jobid"><a href="http://sweeten.com/projects/{{id}}" target="blank">Visit job: {{id}}</a></div>
                
            </div>
        </script> 

    </body>
</html>
